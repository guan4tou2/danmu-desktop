<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      rel="shortcut icon"
      href="{{ url_for('static', filename='favicon.ico') }}"
    />

    <title>Danmu Fire</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;700&display=swap"
      rel="stylesheet"
    />

    <!-- Vanta.js for background effect -->
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r134/three.min.js"
      integrity="sha512-334uBDwY0iZ2TklV1OtDtBW9vp7jjP7SWRzT7Ehu1fdtPIjTpCwTSFb8HI/YBau9L1/kRBEOALrS229Kry4yFQ=="
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/vanta/0.5.24/vanta.net.min.js"
      integrity="sha512-lH/5/byfwH0bqySiiSINJJoEoWFEBGKgOwsnAlZZPviNJI1DDBVXjPHgEkM0fowfOp6NMBAN4ROAYjx+uEkEjQ=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    ></script>

    <style>
      /* Basic styles and fonts */
      body {
        font-family: "Inter", sans-serif;
        background-color: #000000;
      }

      /* Glass effect */
      .glass-effect {
        background: rgba(15, 23, 42, 0.7);
        backdrop-filter: blur(16px) saturate(180%);
        border: 1px solid rgba(255, 255, 255, 0.1);
      }

      /* Custom range input styles */
      input[type="range"] {
        -webkit-appearance: none;
        appearance: none;
        width: 100%;
        height: 6px;
        background: rgba(255, 255, 255, 0.2);
        border-radius: 999px;
        outline: none;
        transition: all 0.2s;
      }

      input[type="range"]::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        width: 20px;
        height: 20px;
        background: #38bdf8;
        cursor: pointer;
        border-radius: 50%;
        border: 2px solid #0f172a;
        transition: all 0.2s;
      }

      input[type="range"]::-webkit-slider-thumb:hover {
        transform: scale(1.1);
        box-shadow: 0 0 10px #38bdf8;
      }

      /* Page load animation */
      @keyframes fadeInScaleUp {
        from {
          opacity: 0;
          transform: scale(0.95);
        }
        to {
          opacity: 1;
          transform: scale(1);
        }
      }
      .animate-fade-in-scale-up {
        animation: fadeInScaleUp 0.5s ease-out forwards;
      }

      /* Blacklist Warning Modal Styles */
      #blacklistWarningModal {
        /* display: none; /* Already set inline, but good for clarity if inline is removed later */
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.6); /* Semi-transparent overlay */
        display: flex; /* Changed from none by JS to flex */
        align-items: center;
        justify-content: center;
        z-index: 1050; /* Higher than toast container (default z-50 for toast) */
        opacity: 0; /* For fade-in effect */
        transition: opacity 0.3s ease-in-out;
        pointer-events: none; /* Initially not interactive */
      }

      #blacklistWarningModal.visible {
        /* Class to show modal */
        opacity: 1;
        pointer-events: auto; /* Interactive when visible */
      }

      #blacklistWarningModal .modal-content {
        background-color: #1e293b; /* Tailwind slate-800 */
        padding: 2rem;
        border-radius: 0.75rem; /* Tailwind rounded-xl */
        text-align: center;
        border: 2px solid #ef4444; /* Tailwind red-500 */
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
        transform: scale(0.95); /* For scale-up effect */
        transition: transform 0.3s ease-in-out;
      }

      #blacklistWarningModal.visible .modal-content {
        transform: scale(1);
      }

      #blacklistWarningModal .warning-triangle {
        fill: #ef4444; /* Tailwind red-500 */
        margin-bottom: 1rem;
        width: 48px; /* Explicit size */
        height: 48px; /* Explicit size */
        display: inline-block; /* Center SVG */
      }

      #blacklistWarningModal .warning-message {
        color: #f1f5f9; /* Tailwind slate-100 */
        font-size: 1.125rem; /* Tailwind text-lg */
        margin-bottom: 1.5rem;
      }

      #blacklistWarningModal .ok-button {
        background-color: #ef4444; /* Tailwind red-500 */
        color: white;
        font-weight: bold;
        padding: 0.75rem 1.5rem;
        border: none;
        border-radius: 0.5rem; /* Tailwind rounded-lg */
        cursor: pointer;
        transition: background-color 0.2s;
      }

      #blacklistWarningModal .ok-button:hover {
        background-color: #dc2626; /* Tailwind red-600 */
      }

      /* Flashing Animation for the modal border */
      @keyframes flashWarningBorder {
        0%,
        100% {
          border-color: #ef4444;
        } /* red-500 */
        50% {
          border-color: #f87171;
        } /* red-400, slightly lighter */
      }

      #blacklistWarningModal.flashing .modal-content {
        animation: flashWarningBorder 0.7s infinite;
      }

      @keyframes flashIcon {
        0%,
        100% {
          transform: scale(1);
          opacity: 1;
        }
        50% {
          transform: scale(1.2);
          opacity: 0.7;
        }
      }

      #blacklistWarningModal.flashing .warning-triangle {
        animation: flashIcon 0.7s infinite steps(1, end);
      }
    </style>
  </head>
  <body
    class="text-white relative min-h-screen flex items-center justify-center p-4"
  >
    <!-- Dynamic background container -->
    <div id="vanta-bg" class="fixed top-0 left-0 w-full h-full z-0"></div>

    <!-- GitHub Icon Link -->
    <a
      href="https://github.com/guan4tou2/danmu-desktop/releases/latest"
      target="_blank"
      rel="noopener noreferrer"
      class="absolute top-6 right-6 text-slate-400 hover:text-white transition-colors duration-300 z-20"
      title="View on GitHub"
    >
      <span class="sr-only">View on GitHub</span>
      <svg
        class="w-10 h-10"
        xmlns="http://www.w3.org/2000/svg"
        viewBox="0 0 24 24"
        fill="currentColor"
      >
        <path
          d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"
        />
      </svg>
    </a>

    <!-- Main content container -->
    <main class="w-full max-w-2xl mx-auto z-10 animate-fade-in-scale-up">
      <div class="glass-effect rounded-3xl shadow-2xl p-6 md:p-8 space-y-6">
        <!-- Title -->
        <h1
          class="text-4xl md:text-5xl font-bold text-center bg-gradient-to-r from-sky-400 to-cyan-300 bg-clip-text text-transparent pb-2"
        >
          Danmu Fire
        </h1>

        <!-- Input area -->
        <div class="relative">
          <textarea
            id="danmuText"
            class="w-full h-32 p-4 bg-slate-800/80 border-2 border-slate-700 rounded-xl focus:ring-2 focus:ring-sky-400 focus:border-sky-400 transition-all duration-300 resize-none placeholder-slate-500"
            placeholder="Type danmu here..."
            maxlength="100"
          ></textarea>
          <div
            id="charCount"
            class="absolute bottom-3 right-4 text-sm text-slate-500"
          >
            0/100
          </div>
        </div>

        <!-- Preview area -->
        <div class="space-y-2">
          <h2 class="text-sm font-semibold text-slate-400">PREVIEW</h2>
          <div
            id="previewText"
            class="w-full min-h-[100px] flex items-center justify-center bg-slate-900/70 rounded-xl p-4 text-slate-400 transition-all duration-300 text-center break-all"
          >
            Preview
          </div>
        </div>

        <!-- Send button -->
        <button
          id="btnSend"
          class="w-full flex items-center justify-center gap-2 bg-gradient-to-r from-sky-500 to-cyan-400 text-white font-bold py-3 px-6 rounded-xl shadow-lg hover:shadow-cyan-400/50 transform hover:-translate-y-1 active:scale-95 transition-all duration-300"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="24"
            height="24"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <path d="M5 12h14" />
            <path d="m12 5 7 7-7 7" />
          </svg>
          <span>Fire Danmu</span>
        </button>

        <!-- Controls -->
        <details class="group">
          <summary
            class="list-none flex items-center justify-center cursor-pointer text-slate-400 hover:text-white transition-colors duration-200"
          >
            <span class="text-sm font-medium">Settings</span>
            <svg
              class="w-5 h-5 ml-1 transform group-open:rotate-180 transition-transform"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
              xmlns="http://www.w3.org/2000/svg"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M19 9l-7 7-7-7"
              ></path>
            </svg>
          </summary>

          <div class="mt-6 grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-6">
            <!-- Color control -->
            {% if Options['Color'][0] %}
            <div id="colorControl" class="space-y-2">
              <label
                for="ColorInput"
                class="text-sm font-medium text-slate-300 flex items-center gap-2"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="16"
                  height="16"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                >
                  <path d="M12 2.69l5.66 5.66a8 8 0 1 1-11.31 0z" />
                </svg>
                Color
              </label>
              <input
                type="color"
                id="ColorInput"
                class="w-full h-10 p-1 bg-slate-800 border-slate-700 rounded-lg cursor-pointer"
              />
            </div>
            {% endif %} {% if Options['FontSize'][0] %}
            <!-- Font size control -->
            <div id="fontSizeControl" class="space-y-2">
              <label
                for="SizeInput"
                class="text-sm font-medium text-slate-300 flex items-center gap-2"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="16"
                  height="16"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                >
                  <path d="M4 7V4h16v3" />
                  <path d="M9 20h6" />
                  <path d="M12 4v16" />
                </svg>
                Font Size
              </label>
              <input
                type="number"
                id="SizeInput"
                min="{{Options['FontSize'][1]}}"
                max="{{Options['FontSize'][2]}}"
                class="w-full bg-slate-800 border-2 border-slate-700 rounded-lg p-2 text-center focus:ring-2 focus:ring-sky-400 focus:border-sky-400 transition-all duration-300"
              />
            </div>
            {% endif %} {% if Options['Opacity'][0] %}
            <!-- Opacity control -->
            <div id="opacityControl" class="space-y-2">
              <label
                for="OpacityRange"
                class="text-sm font-medium text-slate-300 flex items-center justify-between"
              >
                <span class="flex items-center gap-2">
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    width="16"
                    height="16"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  >
                    <path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z" />
                    <circle cx="12" cy="12" r="3" />
                  </svg>
                  Opacity
                </span>
                <span id="opacityValue" class="font-mono text-sky-400"
                  >100%</span
                >
              </label>
              <input
                type="range"
                id="OpacityRange"
                min="{{Options['Opacity'][1]}}"
                max="{{Options['Opacity'][2]}}"
                step="1"
              />
            </div>
            {% endif %} {% if Options['Speed'][0] %}
            <!-- Speed control -->
            <div id="speedControl" class="space-y-2">
              <label
                for="SpeedRange"
                class="text-sm font-medium text-slate-300 flex items-center justify-between"
              >
                <span class="flex items-center gap-2">
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    width="16"
                    height="16"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  >
                    <path d="m12 14 4-4" />
                    <path d="m12 14 4-4" />
                    <path d="M2 12h3.5" />
                    <path d="M18.5 12H22" />
                    <path d="m5 19-2-2" />
                    <path d="m19 5 2 2" />
                    <circle cx="12" cy="12" r="10" />
                  </svg>
                  Speed
                </span>
                <span id="speedValue" class="font-mono text-sky-400">10</span>
              </label>
              <input
                type="range"
                id="speedRange"
                min="{{Options['Speed'][1]}}"
                max="{{Options['Speed'][2]}}"
                step="1"
              />
              <small class="text-slate-500 text-xs"
                >Higher value = Faster speed</small
              >
            </div>
            {% endif %}
          </div>
        </details>
      </div>
    </main>

    <!-- Toast message container -->
    <div
      id="toast-container"
      class="fixed top-5 right-5 z-50 flex flex-col items-end"
    >
      <!-- Toasts will be dynamically inserted here -->
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        // --- VANTA.js background initialization ---
        VANTA.NET({
          el: "#vanta-bg",
          mouseControls: true,
          touchControls: true,
          gyroControls: false,
          minHeight: 200.0,
          minWidth: 200.0,
          scale: 1.0,
          scaleMobile: 1.0,
          color: 0x3b82f6,
          backgroundColor: 0x000000,
          points: 12.0,
          maxDistance: 25.0,
          spacing: 18.0,
        });

        // --- Element selectors ---
        const elements = {
          danmuText: document.getElementById("danmuText"),
          charCount: document.getElementById("charCount"),
          previewText: document.getElementById("previewText"),
          btnSend: document.getElementById("btnSend"),

          // Controls
          colorControl: document.getElementById("colorControl"),
          colorInput: document.getElementById("ColorInput"),
          opacityControl: document.getElementById("opacityControl"),
          opacityRange: document.getElementById("OpacityRange"),
          opacityValue: document.getElementById("opacityValue"),
          fontSizeControl: document.getElementById("fontSizeControl"),
          sizeInput: document.getElementById("SizeInput"),
          speedControl: document.getElementById("speedControl"),
          speedRange: document.getElementById("speedRange"),
          speedValue: document.getElementById("speedValue"),

          // Toast container
          toastContainer: document.getElementById("toast-container"),

          // Blacklist Warning Modal Elements
          blacklistWarningModal: document.getElementById('blacklistWarningModal'),
          blacklistWarningMessage: document.getElementById('blacklistWarningMessage'),
          // blacklistWarningOkButton: document.getElementById('blacklistWarningOkButton'), // Removed
        };

        // --- State management ---
        let currentSettings = {};
        let ws = null;
        let autoDismissTimer = null;

        // --- Functions ---

        async function checkTextAgainstBlacklist(text) {
            try {
                const response = await fetch('/check_blacklist', {
                    method: 'POST',
                    credentials: 'same-origin',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ text: text })
                });
                if (response.ok) {
                    const result = await response.json();
                    return result.blocked;
                } else {
                    console.error('Failed to check blacklist:', response.statusText);
                    return false; // 如果检查失败，允许发送
                }
            } catch (error) {
                console.error('Error checking blacklist:', error);
                return false; // 如果检查失败，允许发送
            }
        }

        function showBlacklistWarningModal(message) {
            if (elements.blacklistWarningModal && elements.blacklistWarningMessage) {
                elements.blacklistWarningMessage.textContent = message;
                elements.blacklistWarningModal.style.display = 'flex';

                // Clear any existing timer before setting a new one
                if (autoDismissTimer) {
                    clearTimeout(autoDismissTimer);
                }
                autoDismissTimer = setTimeout(hideBlacklistWarningModal, 5000); // Auto-dismiss after 5 seconds

                setTimeout(() => {
                    elements.blacklistWarningModal.classList.add('visible');
                    elements.blacklistWarningModal.classList.add('flashing');
                }, 20);
            }
        }

        function hideBlacklistWarningModal() {
            if (autoDismissTimer) { // Clear the auto-dismiss timer if it's active
                clearTimeout(autoDismissTimer);
                autoDismissTimer = null;
            }
            if (elements.blacklistWarningModal) {
                elements.blacklistWarningModal.classList.remove('visible');
                elements.blacklistWarningModal.classList.remove('flashing');
                setTimeout(() => {
                    elements.blacklistWarningModal.style.display = 'none';
                }, 300);
            }
        }

        // Show toast message (stackable version)
        function showToast(message, isSuccess = true) {
          // 1. Create toast element
          const toastElement = document.createElement("div");
          toastElement.className =
            "flex items-center w-full max-w-xs p-4 mb-4 space-x-4 text-gray-500 bg-white divide-x divide-gray-200 rounded-lg shadow dark:text-gray-400 dark:divide-gray-700 space-x dark:bg-gray-800 transform transition-all duration-300 ease-in-out opacity-0 translate-x-full";
          toastElement.setAttribute("role", "alert");

          // 2. Create toast content
          const iconSvg = isSuccess
            ? `<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`
            : `<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`;
          const iconColorClass = isSuccess ? "text-green-500" : "text-red-500";

          toastElement.innerHTML = `
                <div class="${iconColorClass}">${iconSvg}</div>
                <div class="pl-4 text-sm font-normal">${message}</div>
            `;

          // 3. Add to container
          elements.toastContainer.appendChild(toastElement);

          // 4. Trigger enter animation
          requestAnimationFrame(() => {
            toastElement.classList.remove("opacity-0", "translate-x-full");
          });

          // 5. Set timer to remove toast
          setTimeout(() => {
            toastElement.classList.add("opacity-0", "translate-x-full");

            toastElement.addEventListener("transitionend", () => {
              toastElement.remove();
            });
          }, 3000);
        }

        // Check if URL is an image
        const isImageUrl = (url) =>
          url && url.match(/\.(jpeg|jpg|gif|png|webp|svg)$/i) != null;

        // Update character count
        const updateCharCount = () => {
          const count = elements.danmuText.value.length;
          elements.charCount.textContent = `${count}/100`;
          elements.charCount.classList.toggle("text-red-400", count >= 90);
        };

        // Update preview
        const updatePreview = () => {
          const content = elements.danmuText.value.trim();
          const previewContent = content || "Preview";

          if (isImageUrl(content)) {
            elements.previewText.innerHTML = `<img src="${content}" alt="Preview Image" class="max-h-24 rounded-lg object-contain">`;
            elements.previewText.style.color = "";
          } else {
            elements.previewText.textContent = previewContent;
            elements.previewText.style.color = currentSettings.color;
            elements.previewText.style.fontSize = `${currentSettings.fontSize}px`;
          }
          elements.previewText.style.opacity = currentSettings.opacity / 100;
        };

        // Update UI controls
        const updateUIControls = () => {
          {% if Options['Color'][0] %}
          elements.colorInput.value = currentSettings.color;
          elements.colorControl.style.display = currentSettings.randomColor
            ? "block"
            : "none";
          {% endif %}
          {% if Options['Opacity'][0] %}
          elements.opacityRange.value = currentSettings.opacity;
          elements.opacityValue.textContent = `${currentSettings.opacity}%`;
          elements.opacityControl.style.display = currentSettings.randomOpacity
            ? "block"
            : "none";
          {% endif %}
          {% if Options['FontSize'][0] %}
          elements.sizeInput.value = currentSettings.fontSize;
          elements.fontSizeControl.style.display =
            currentSettings.randomFontSize ? "block" : "none";
          {% endif %}
          {% if Options['Speed'][0] %}
          elements.speedRange.value = currentSettings.speed;
          elements.speedValue.textContent = `${currentSettings.speed}`;
          elements.speedControl.style.display = currentSettings.randomSpeed
            ? "block"
            : "none";
          {% endif %}
        };

        // Fetch latest settings from backend
        function fetchLatestSettings() {
          fetch("/get_settings", {
            method: "GET",
            credentials: "same-origin",
          })
            .then((response) => response.json())
            .then((data) => {
              // Update current settings
              currentSettings = {
                color: data.Color[3],
                opacity: data.Opacity[3],
                fontSize: data.FontSize[3],
                speed: data.Speed[3],
                randomColor: data.Color[0],
                randomOpacity: data.Opacity[0],
                randomFontSize: data.FontSize[0],
                randomSpeed: data.Speed[0],
              };

              // Update UI controls
              updateUIControls();

              // Update preview
              updatePreview();

              // Update controls visibility
              updateControlsVisibility();
            })
            .catch((error) => console.error("Fetch failed:", error));
        }

        // --- WebSocket ---
        function connectWebSocket() {
          {% if ws_url %}
          ws = new WebSocket("{{ ws_url }}");
          {% else %}
          ws = new WebSocket(`ws://${window.location.host}/`);
          {% endif %}
          console.log(`Connecting to WebSocket: {{ws_url}}`);

          ws.onopen = function () {
            console.log("WebSocket Connection Opened");
          };

          ws.onmessage = function (event) {
            try {
              const data = JSON.parse(event.data);

              // If settings changed notification
              if (data.type === "settings_changed") {
                console.log("Settings updated:", data.settings);

                // Update current settings
                currentSettings = {
                  color: data.settings.Color[3],
                  opacity: data.settings.Opacity[3],
                  fontSize: data.settings.FontSize[3],
                  speed: data.settings.Speed[3],
                  randomColor: data.settings.Color[0],
                  randomOpacity: data.settings.Opacity[0],
                  randomFontSize: data.settings.FontSize[0],
                  randomSpeed: data.settings.Speed[0],
                };

                // Update UI controls
                updateUIControls();

                // Update preview
                updatePreview();

                // Update controls visibility
                updateControlsVisibility();
              }
            } catch (error) {
              console.error("Process WebSocket error:", error);
            }
          };

          ws.onclose = function () {
            console.log("WebSocket Connection Closed");
            // Try to reconnect
            setTimeout(connectWebSocket, 3000);
          };

          ws.onerror = function (error) {
            console.error("WebSocket Error:", error);
          };
        }

        // Update controls visibility
        function updateControlsVisibility() {
          // Get all control groups
          const controlGroups = document.querySelectorAll(".control-group");
          const controlsContainer = document.querySelector(
            ".controls-container"
          );

          // If no visible controls, hide the entire container
          let hasVisibleControls = false;

          // Update color control visibility
          const colorControl = document.querySelector('[data-control="Color"]');
          if (colorControl) {
            if (currentSettings.randomColor) {
              colorControl.style.display = "block";
              hasVisibleControls = true;
            } else {
              colorControl.style.display = "none";
            }
          }

          // Update opacity control visibility
          const opacityControl = document.querySelector(
            '[data-control="Opacity"]'
          );
          if (opacityControl) {
            if (currentSettings.randomOpacity) {
              opacityControl.style.display = "block";
              hasVisibleControls = true;
            } else {
              opacityControl.style.display = "none";
            }
          }

          // Update font size control visibility
          const fontSizeControl = document.querySelector(
            '[data-control="FontSize"]'
          );
          if (fontSizeControl) {
            if (currentSettings.randomFontSize) {
              fontSizeControl.style.display = "block";
              hasVisibleControls = true;
            } else {
              fontSizeControl.style.display = "none";
            }
          }

          // Update speed control visibility
          const speedControl = document.querySelector('[data-control="Speed"]');
          if (speedControl) {
            if (currentSettings.randomSpeed) {
              speedControl.style.display = "block";
              hasVisibleControls = true;
            } else {
              speedControl.style.display = "none";
            }
          }

          // Use CSS class to control container visibility
          if (controlsContainer) {
            if (hasVisibleControls) {
              controlsContainer.classList.remove("hidden");
            } else {
              controlsContainer.classList.add("hidden");
            }
          }
        }

        // --- Event listeners ---
        elements.danmuText.addEventListener("input", () => {
          updateCharCount();
          updatePreview();
        });

        {% if Options['Color'][0] %}
        elements.colorInput.addEventListener("input", (e) => {
          currentSettings.color = e.target.value;
          updatePreview();
        });
        {% endif %}

        {% if Options['Opacity'][0] %}
        elements.opacityRange.addEventListener("input", (e) => {
          currentSettings.opacity = parseInt(e.target.value);
          elements.opacityValue.textContent = `${currentSettings.opacity}%`;
          updatePreview();
        });
        {% endif %}

        {% if Options['FontSize'][0] %}
        elements.sizeInput.addEventListener("input", (e) => {
          currentSettings.fontSize = e.target.value;
          updatePreview();
        });
        {% endif %}

        {% if Options['Speed'][0] %}
        elements.speedRange.addEventListener("input", (e) => {
          currentSettings.speed = parseInt(e.target.value);
          elements.speedValue.textContent = `${currentSettings.speed}`;
          updatePreview();
        });
        {% endif %}

        elements.danmuText.addEventListener("keydown", (e) => {
          if (e.key === "Enter" && !e.shiftKey) {
            e.preventDefault();
            elements.btnSend.click();
          }
        });

        elements.btnSend.addEventListener("click", async () => {
          const content = elements.danmuText.value.trim();
          if (!content) {
            showToast("Please enter danmu content!", false);
            return;
          }

          // ---- START OF NEW BLACKLIST CHECK ----
          const blocked = await checkTextAgainstBlacklist(content);
          if (blocked) {
              showBlacklistWarningModal("Warning: Message contains blocked words and was not sent.");
              return; // Stop further processing and do not send
          }
          // ---- END OF NEW BLACKLIST CHECK ----

          const payload = {
            text: content,
            opacity: currentSettings.opacity,
            color: currentSettings.color.replace("#", ""),
            size: currentSettings.fontSize,
            speed: currentSettings.speed,
          };

          console.log("Firing danmu:", payload);

          elements.btnSend.disabled = true;
          elements.btnSend.innerHTML = `
                    <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <span>Firing...</span>`;

          // --- Fetch request ---
          fetch("/fire", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(payload),
          })
            .then((response) => {
              if (response.redirected) {
                window.location.href = response.url;
              } else {
                elements.danmuText.value = "";
                showToast("Fire Danmu Success!");
                updateCharCount();
                updatePreview();
                elements.btnSend.disabled = false;
                elements.btnSend.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14"/><path d="m12 5 7 7-7 7"/></svg>
                <span>Fire Danmu</span>`;
              }
            })
            .catch(function (error) {
              console.error("Error:", error);
              elements.btnSend.disabled = false;
              elements.btnSend.innerHTML = `
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14"/><path d="m12 5 7 7-7 7"/></svg>
              <span>Fire Danmu</span>`;
              showToast("Send failed, please try again later.", false);
            });
        });

        // --- Initialize ---
        async function init() {
          updateUIControls();
          updatePreview();
          await fetchLatestSettings();
          connectWebSocket();
        }

        init();

        // Event listeners for Blacklist Warning Modal
        // if (elements.blacklistWarningOkButton) { // Removed
        //     elements.blacklistWarningOkButton.addEventListener('click', hideBlacklistWarningModal);
        // }
        if (elements.blacklistWarningModal) {
            elements.blacklistWarningModal.addEventListener('click', function(event) {
                if (event.target === elements.blacklistWarningModal) { // Clicked on overlay, not content
                    hideBlacklistWarningModal();
                }
            });
        }

      });
    </script>

    <!-- Blacklist Warning Modal -->
    <div id="blacklistWarningModal" style="display: none">
      <!-- Initially hidden -->
      <div class="modal-content">
        <svg
          class="warning-triangle"
          xmlns="http://www.w3.org/2000/svg"
          viewBox="0 0 24 24"
          fill="currentColor"
          width="48px"
          height="48px"
        >
          <path d="M1 21h22L12 2 1 21zm12-3h-2v-2h2v2zm0-4h-2v-4h2v4z" />
        </svg>
        <p id="blacklistWarningMessage" class="warning-message">
          Warning message here.
        </p>
        <!-- <button id="blacklistWarningOkButton" class="ok-button">OK</button> Removed -->
      </div>
    </div>
  </body>
</html>
